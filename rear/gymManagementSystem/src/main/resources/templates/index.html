<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>体育场馆管理系统</title>
    <!-- 引入Element UI样式 - 使用国内CDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/theme-chalk/index.css">
    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="/css/main.css">
    <style>
        /* 添加v-cloak指令样式 */
        [v-cloak] {
            display: none;
        }

        /* 添加场地预约页面样式 */
        .venue-booking-container {
            padding: 10px;
        }
        .time-slots-container {
            margin: 15px 0;
        }
        .time-slot {
            padding: 10px;
            text-align: center;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #dcdfe6;
        }
        .time-slot.available {
            background-color: #f0f9eb;
            color: #67c23a;
        }
        .time-slot.booked {
            background-color: #f56c6c;
            color: white;
            cursor: not-allowed;
        }
        .time-slot.special {
            background-color: #e6a23c;
            color: white;
            cursor: not-allowed;
        }
        .time-slot.selected {
            border: 2px solid #409eff;
            box-shadow: 0 0 5px rgba(64, 158, 255, 0.5);
        }
        .venue-detail {
            display: flex;
            flex-wrap: wrap;
        }
        .venue-image {
            flex: 0 0 100%;
            margin-bottom: 15px;
            text-align: center;
        }
        .venue-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
        }
        .venue-info {
            flex: 1;
        }
        .booking-summary {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f7fa;
            border-radius: 4px;
        }
        .pagination-container {
            margin-top: 20px;
            text-align: right;
        }
        /* 添加场地使用页面样式 */
        .venue-usage-container {
            padding: 10px;
        }
        .usage-timer-card {
            height: 100%;
        }
        .timer-container {
            text-align: center;
            padding: 20px 0;
        }
        .timer-label {
            font-size: 16px;
            color: #606266;
            margin-bottom: 10px;
        }
        .timer-display {
            font-size: 36px;
            font-weight: bold;
            margin: 20px 0;
            color: #409EFF;
        }
        .cost-container {
            margin: 20px 0;
        }
        .cost-label {
            font-size: 16px;
            color: #606266;
        }
        .cost-display {
            font-size: 24px;
            color: #F56C6C;
            font-weight: bold;
            margin: 10px 0;
        }
        .timer-actions {
            margin-top: 30px;
        }
        .empty-usage {
            padding: 40px 0;
        }
        .no-usage-card {
            height: 100%;
        }
        .highlight-cost {
            color: #F56C6C;
            font-weight: bold;
        }
        .overtime-tag {
            font-size: 12px;
            color: #E6A23C;
            margin-left: 5px;
        }
        .payment-options {
            margin-top: 20px;
        }
    </style>

</head>
<body>
<div id="app">
    <div v-cloak>
        <el-container>
            <el-header>
                <div class="logo">体育场馆管理系统</div>
                <div class="user-info" v-if="currentUser">
                    <span>{{ currentUser.name }}</span>
                    <el-dropdown trigger="click" @command="handleCommand">
                            <span class="el-dropdown-link">
                                {{ currentUser.role === 'ADMIN' ? '场地管理员' : '普通用户' }}<i class="el-icon-arrow-down el-icon--right"></i>
                            </span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </div>
            </el-header>

            <el-container>
                <el-aside width="200px" v-if="currentUser">
                    <el-menu default-active="1" class="el-menu-vertical" :router="true">
                        <!-- 场地管理员菜单 -->
                        <template v-if="currentUser.role === 'ADMIN'">
                            <el-menu-item index="/admin/venues">
                                <i class="el-icon-location"></i>
                                <span slot="title">场地管理</span>
                            </el-menu-item>
                            <el-menu-item index="/admin/reservations">
                                <i class="el-icon-document"></i>
                                <span slot="title">预约管理</span>
                            </el-menu-item>
                            <el-menu-item index="/admin/special">
                                <i class="el-icon-star-on"></i>
                                <span slot="title">特殊场地管理</span>
                            </el-menu-item>
                            <el-menu-item index="/admin/noshows">
                                <i class="el-icon-warning"></i>
                                <span slot="title">失约处理</span>
                            </el-menu-item>
                            <el-menu-item index="/admin/announcements">
                                <i class="el-icon-bell"></i>
                                <span slot="title">场馆公告</span>
                            </el-menu-item>
                        </template>

                        <!-- 普通用户菜单 -->
                        <template v-else>
                            <el-menu-item index="/user/venues">
                                <i class="el-icon-location"></i>
                                <span slot="title">场地预约</span>
                            </el-menu-item>
                            <el-menu-item index="/user/myreservations">
                                <i class="el-icon-document"></i>
                                <span slot="title">我的预约</span>
                            </el-menu-item>
                            <el-menu-item index="/user/usage">
                                <i class="el-icon-time"></i>
                                <span slot="title">场地使用</span>
                            </el-menu-item>
                            <el-menu-item index="/user/schedule">
                                <i class="el-icon-date"></i>
                                <span slot="title">场地安排</span>
                            </el-menu-item>
                            <el-menu-item index="/user/prices">
                                <i class="el-icon-money"></i>
                                <span slot="title">收费标准</span>
                            </el-menu-item>
                        </template>
                    </el-menu>
                </el-aside>

                <el-main>
                    <router-view></router-view>
                </el-main>
            </el-container>
        </el-container>
    </div>
</div>

<!-- 引入Vue.js -->
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>
<!-- 引入Vue Router -->
<script src="https://cdn.bootcdn.net/ajax/libs/vue-router/3.5.3/vue-router.min.js"></script>
<!-- 引入Element UI组件库 -->
<script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/index.js"></script>
<!-- 引入Axios -->
<script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>

<!-- 引入场地预约组件 -->
<script src="/js/user-venues.js"></script>
<!-- 引入我的预约组件 -->
<script src="/js/user-reservations.js"></script>
<!-- 引入场地使用组件 -->
<script src="/js/user-usage.js"></script>

<script>
    // API基础URL
    const API_BASE_URL = '/api';

    // Axios全局配置
    axios.defaults.baseURL = API_BASE_URL;
    axios.defaults.headers.common['Content-Type'] = 'application/json';

    // 添加请求拦截器，设置token等
    axios.interceptors.request.use(config => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers['Authorization'] = `Bearer ${token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    // 添加响应拦截器，处理错误等
    axios.interceptors.response.use(response => {
        return response;
    }, error => {
        if (error.response && error.response.status === 401) {
            // 未授权，跳转到登录页面
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            router.push('/login');
        }
        return Promise.reject(error);
    });

    // 组件定义
    // 登录组件
    const LoginComponent = {
        template: `
        <div class="login-container">
            <el-card class="login-card">
                <div slot="header" class="card-header">
                    <h2>登录体育场馆管理系统</h2>
                </div>
                <el-form :model="loginForm" :rules="rules" ref="loginForm">
                    <el-form-item prop="username">
                        <el-input v-model="loginForm.username" prefix-icon="el-icon-user" placeholder="用户名"></el-input>
                    </el-form-item>
                    <el-form-item prop="password">
                        <el-input v-model="loginForm.password" prefix-icon="el-icon-lock" type="password" placeholder="密码"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="handleLogin" style="width: 100%">登录</el-button>
                    </el-form-item>
                </el-form>
            </el-card>
        </div>
    `,
        data() {
            return {
                loginForm: {
                    username: '',
                    password: ''
                },
                rules: {
                    username: [
                        { required: true, message: '请输入用户名', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: '请输入密码', trigger: 'blur' }
                    ]
                }
            };
        },
        methods: {
            handleLogin() {
                this.$refs.loginForm.validate(valid => {
                    if (valid) {
                        // 模拟登录成功
                        localStorage.setItem('token', 'demo-token');
                        const user = {
                            id: 1,
                            name: '测试用户',
                            role: 'USER'
                        };
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        this.$router.push('/user/venues');
                        // 通知父组件更新用户信息
                        this.$root.currentUser = user;
                    }
                });
            }
        }
    };

    // 简化的组件定义
    const AdminVenuesComponent = { template: "<div>场地管理</div>" };
    const AdminReservationsComponent = { template: "<div>预约管理</div>" };
    const AdminSpecialComponent = { template: "<div>特殊场地管理</div>" };
    const AdminNoshowsComponent = { template: "<div>失约处理</div>" };
    const AdminAnnouncementsComponent = { template: "<div>场馆公告</div>" };

    //const UserVenuesComponent = { template: "<div>场地预约</div>" };
    //const UserReservationsComponent = { template: "<div>我的预约</div>" };
    //const UserUsageComponent = { template: "<div>场地使用</div>" };
    const UserScheduleComponent = { template: "<div>场地安排</div>" };
    const UserPricesComponent = { template: "<div>收费标准</div>" };

    // 路由配置
    const routes = [
        {
            path: '/',
            redirect: '/login'
        },
        {
            path: '/login',
            component: LoginComponent
        },
        // 场地管理员路由
        {
            path: '/admin/venues',
            component: AdminVenuesComponent,
            meta: { requiresAuth: true, role: 'ADMIN' }
        },
        {
            path: '/admin/reservations',
            component: AdminReservationsComponent,
            meta: { requiresAuth: true, role: 'ADMIN' }
        },
        {
            path: '/admin/special',
            component: AdminSpecialComponent,
            meta: { requiresAuth: true, role: 'ADMIN' }
        },
        {
            path: '/admin/noshows',
            component: AdminNoshowsComponent,
            meta: { requiresAuth: true, role: 'ADMIN' }
        },
        {
            path: '/admin/announcements',
            component: AdminAnnouncementsComponent,
            meta: { requiresAuth: true, role: 'ADMIN' }
        },
        // 普通用户路由
        {
            path: '/user/venues',
            component: UserVenuesComponent,
            meta: { requiresAuth: true, role: 'USER' }
        },
        {
            path: '/user/myreservations',
            component: UserReservationsComponent,
            meta: { requiresAuth: true, role: 'USER' }
        },
        {
            path: '/user/usage',
            component: UserUsageComponent,
            meta: { requiresAuth: true, role: 'USER' }
        },
        {
            path: '/user/schedule',
            component: UserScheduleComponent,
            meta: { requiresAuth: true, role: 'USER' }
        },
        {
            path: '/user/prices',
            component: UserPricesComponent,
            meta: { requiresAuth: true, role: 'USER' }
        }
    ];

    // 创建路由实例
    const router = new VueRouter({
        routes
    });

    // 路由守卫
    router.beforeEach((to, from, next) => {
        const requiresAuth = to.matched.some(record => record.meta.requiresAuth);
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        if (requiresAuth && !currentUser) {
            next('/login');
        } else if (requiresAuth && to.meta.role && to.meta.role !== currentUser.role) {
            next('/'); // 权限不足，重定向到主页
        } else {
            next();
        }
    });

    // 全局Vue实例
    const app = new Vue({
        el: '#app',
        router,
        data() {
            return {
                currentUser: null,
            };
        },
        created() {
            // 从本地存储中恢复用户信息
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                try {
                    this.currentUser = JSON.parse(userStr);
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        },
        methods: {
            handleCommand(command) {
                if (command === 'logout') {
                    this.logout();
                }
            },
            logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                this.currentUser = null;
                this.$message.success('已成功退出登录');
                this.$router.push('/login');
            }
        }
    });
</script>
</body>

</html>